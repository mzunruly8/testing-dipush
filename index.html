<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d', { alpha: false });

const rollBtn = document.getElementById('rollBtn');
const scoreText = document.getElementById('scoreText');
const streakText = document.getElementById('streakText');
const levelText = document.getElementById('levelText');
const shapeText = document.getElementById('shapeText');
const statusText = document.getElementById('statusText');
const premiumBtn = document.getElementById('premiumBtn');

let barY = 0;
let players = [];
let enemies = [];
let obstacles = [];
let particles = [];
let multiplierGates = [];

let enemyTimer = 0;
let obstacleTimer = 0;
let animationId;

let gameActive = false;
let canRoll = true;

let level = 1;
let premium = false;

let score = 0;
let streak = 0;
let combo = 1;
let timeAlive = 0;

let cannonX = 0;
let cannonAngle = -Math.PI/2;
let barVelocity = 0;

function resizeCanvas() {
    const parent = document.getElementById('canvasParent');
    canvas.width = parent.clientWidth;
    canvas.height = parent.clientHeight;
    cannonX = canvas.width / 2;
    barY = canvas.height / 2;
}

function spawnPlayer(x = cannonX, y = canvas.height - 30, vx, vy) {
    const speed = 7;
    players.push({
        x,
        y,
        vx: vx ?? Math.cos(cannonAngle) * speed,
        vy: vy ?? Math.sin(cannonAngle) * speed,
        r: 8,
        dead: false
    });
}

function spawnEnemy() {
    enemies.push({
        x: 30 + Math.random() * (canvas.width - 60),
        y: -20,
        speed: 2 + level * 0.2,
        r: 8,
        dead: false
    });
}

function spawnObstacle() {
    obstacles.push({
        x: 50 + Math.random() * (canvas.width - 100),
        y: -20,
        w: 60,
        h: 14,
        speed: 1.5 + level * 0.1
    });
}

function spawnGate() {
    multiplierGates = [{
        x: 60 + Math.random() * (canvas.width - 120),
        y: barY + 100,
        w: 70,
        h: 40,
        val: 2 + Math.floor(level/3)
    }];
}

function createBurst(x,y,color="#22c55e"){
    for(let i=0;i<6;i++){
        particles.push({
            x,y,
            vx:(Math.random()-0.5)*6,
            vy:(Math.random()-0.5)*6,
            life:1,
            color
        });
    }
}

function triggerFire() {
    if (!gameActive || !canRoll) return;
    canRoll = false;

    let elapsed = 0;
    const rolling = setInterval(() => {
        rollBtn.textContent = "ROLLING: " + (Math.floor(Math.random()*6)+1);
        elapsed += 60;

        if (elapsed >= 500) {
            clearInterval(rolling);

            let roll = Math.floor(Math.random()*6)+1;
            if (premium) roll++;

            rollBtn.textContent = "FIRED " + roll;

            if (roll >= 6) combo++;
            else combo = 1;

            for (let i=0;i<roll;i++){
                setTimeout(()=>spawnPlayer(), i*70);
            }

            setTimeout(()=>{
                canRoll = true;
                if(gameActive) rollBtn.textContent="DRAG TO AIM - RELEASE TO FIRE";
            },600);
        }
    },60);
}

function loop(){
    if(!gameActive) return;

    ctx.fillStyle="#020617";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    timeAlive++;

    enemyTimer++;
    if(enemyTimer>Math.max(20,40-level*3)){
        spawnEnemy();
        enemyTimer=0;
    }

    obstacleTimer++;
    if(obstacleTimer>160-level*6){
        spawnObstacle();
        obstacleTimer=0;
    }

    let pushForce = 0;
    const barTop = barY-15;
    const barBottom = barY+15;

    // Obstacles
    ctx.fillStyle="#ef4444";
    obstacles.forEach(o=>{
        o.y+=o.speed;
        ctx.fillRect(o.x-o.w/2,o.y-o.h/2,o.w,o.h);
    });

    // Players
    ctx.fillStyle="#3b82f6";
    for(let i=players.length-1;i>=0;i--){
        let p=players[i];
        p.x+=p.vx;
        p.y+=p.vy;

        if(p.x<8||p.x>canvas.width-8) p.vx*=-1;

        if(!p.dead && p.y<=barBottom && p.y>=barTop){
            pushForce -= 1.2*combo;
            createBurst(p.x,p.y,"#3b82f6");
            p.dead=true;
            score+=combo*2;
        }

        if(p.dead||p.y<-40){
            players.splice(i,1);
            continue;
        }

        ctx.beginPath();
        ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
        ctx.fill();
    }

    // Enemies
    ctx.fillStyle="#ef4444";
    for(let i=enemies.length-1;i>=0;i--){
        let e=enemies[i];
        e.y+=e.speed;

        if(!e.dead && e.y>=barTop && e.y<=barBottom){
            pushForce += 1.4+level*0.1;
            createBurst(e.x,e.y,"#ef4444");
            e.dead=true;
        }

        if(e.dead||e.y>canvas.height+40){
            enemies.splice(i,1);
            continue;
        }

        ctx.beginPath();
        ctx.arc(e.x,e.y,e.r,0,Math.PI*2);
        ctx.fill();
    }

    // Smooth physics
    barVelocity += pushForce;
    barVelocity *= 0.9; // damping
    barVelocity += 0.15; // light gravity

    barY += barVelocity;
    barY = Math.max(20,Math.min(canvas.height-20,barY));

    ctx.fillStyle="#1e293b";
    ctx.fillRect(0,barY-15,canvas.width,30);
    ctx.strokeStyle="#0ea5e9";
    ctx.strokeRect(0,barY-15,canvas.width,30);

    scoreText.textContent=Math.floor(score);
    streakText.textContent=streak;
    levelText.textContent=level;

    if(barY<=21){
        streak++;
        level++;
        end(true);
    }
    else if(barY>=canvas.height-21){
        streak=0;
        end(false);
    }
    else animationId=requestAnimationFrame(loop);
}

function startGame(){
    players=[]; enemies=[]; obstacles=[]; particles=[];
    score=0; combo=1; timeAlive=0;
    barVelocity=0;
    barY=canvas.height/2;
    gameActive=true;
    rollBtn.textContent="DRAG TO AIM - RELEASE TO FIRE";
    statusText.textContent="BATTLE";
    spawnGate();
    loop();
}

function end(win){
    gameActive=false;
    cancelAnimationFrame(animationId);
    rollBtn.textContent=win?"WIN! RESTART":"OVER. RESTART";
    statusText.textContent=win?"VICTORY":"DEFEAT";
}

canvas.addEventListener("touchstart",e=>{
    if(!gameActive){startGame();return;}
},{passive:false});

canvas.addEventListener("touchend",()=>{
    if(gameActive) triggerFire();
},{passive:false});

rollBtn.addEventListener("click",()=>{
    if(!gameActive) startGame();
});

premiumBtn.addEventListener("click",()=>{
    premium=!premium;
    premiumBtn.textContent=premium?"PREM ON":"PREM OFF";
});

window.addEventListener("load",resizeCanvas);
window.addEventListener("resize",resizeCanvas);
</script>